{% extends 'layouts/page.njk' %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      
      <h1 class="govuk-heading-l">Content Review Assistant</h1>
      
      <!-- Upload Success Message -->
      {% if uploadSuccess %}
      <div class="govuk-notification-banner govuk-notification-banner--success" role="alert" aria-labelledby="upload-success-title" data-module="govuk-notification-banner">
        <div class="govuk-notification-banner__header">
          <h2 class="govuk-notification-banner__title" id="upload-success-title">
            Success
          </h2>
        </div>
        <div class="govuk-notification-banner__content">
          <h3 class="govuk-notification-banner__heading">
            Document uploaded successfully
          </h3>
          <p class="govuk-body">
            <strong>{{ uploadSuccess.filename }}</strong> ({{ (uploadSuccess.size / 1024) | round(2) }} KB) has been uploaded and scanned.
          </p>
        </div>
      </div>
      {% endif %}

      <!-- Upload Error Message -->
      {% if uploadError %}
      <div class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert" tabindex="-1" data-module="govuk-error-summary">
        <h2 class="govuk-error-summary__title" id="error-summary-title">
          Upload failed
        </h2>
        <div class="govuk-error-summary__body">
          <p class="govuk-body">{{ uploadError }}</p>
        </div>
      </div>
      {% endif %}

      <p class="govuk-body">
        Upload a document or paste content below for review. The content will be analyzed for clarity, formatting and compliance with GOV.UK standards.
      </p>

      <!-- Content Review Form -->
      <div class="govuk-!-margin-bottom-6">
        <form id="reviewForm" enctype="multipart/form-data">
          
          <!-- File Upload Option -->
          <div class="govuk-form-group" id="fileFormGroup">
            <label class="govuk-label govuk-label--s" for="file-upload">
              Upload a document (optional)
            </label>
            <div class="govuk-hint">
              Accepted file types: PDF (.pdf), Word (.doc, .docx). Maximum file size: 10MB
            </div>
            <input class="govuk-file-upload" id="file-upload" name="file" type="file" accept=".pdf,.doc,.docx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
          </div>

          <!-- Text Input Option -->
          <div class="govuk-form-group">
            <label class="govuk-label govuk-label--s" for="userInput">
              Or type/paste your content directly
            </label>
            <textarea 
              id="userInput" 
              class="govuk-textarea" 
              rows="5" 
              placeholder="Type or paste content here..."
              aria-label="Content input for review"
            ></textarea>
          </div>
          
          <button 
            type="submit" 
            class="govuk-button"
            data-module="govuk-button"
            id="reviewButton"
          >
            Review Content
          </button>
        </form>
      </div>

      <!-- Document Review History Table -->
      <div class="govuk-!-margin-top-8">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <h2 class="govuk-heading-m">Review History</h2>
          <button type="button" class="govuk-button govuk-button--secondary" data-module="govuk-button" id="resetHistoryBtn" style="margin: 0;">
            Reset Demo Data
          </button>
        </div>
        
        <table class="govuk-table" id="reviewHistoryTable">
          <thead class="govuk-table__head">
            <tr class="govuk-table__row">
              <th scope="col" class="govuk-table__header">Uploaded Document</th>
              <th scope="col" class="govuk-table__header">Method</th>
              <th scope="col" class="govuk-table__header">Status</th>
              <th scope="col" class="govuk-table__header">Timestamp</th>
              <th scope="col" class="govuk-table__header">Result</th>
            </tr>
          </thead>
          <tbody class="govuk-table__body" id="reviewHistoryBody">
            <!-- Sample data - will be populated dynamically -->
            <tr class="govuk-table__row">
              <td class="govuk-table__cell" colspan="5">
                <p class="govuk-body">No documents uploaded yet.</p>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

    </div>
  </div>

{% endblock %}

{% block bodyEnd %}
  <script nonce="{{ cspNonce }}">
    console.log('Review History Script Loading...');
    
    // Configure backend API URL
    window.APP_CONFIG = {
      backendApiUrl: 'http://localhost:3001'
    };

    // Review history data (mock data - will be replaced with API calls)
    // Simulating different stages of the workflow:
    // 1. File uploaded to S3 bucket
    // 2. Message sent to SQS queue
    // 3. SQS Orchestrator picks up the message
    // 4. LLM reviews the content
    // 5. Result saved to S3 bucket
    // 6. Result displayed in Web UI
    
    // Initialize default dummy data
    const defaultReviewHistory = [
      {
        id: 1001,
        documentName: 'GOV.UK_Service_Standards.pdf',
        method: 'Review Content',
        status: 'Completed',
        timestamp: new Date(Date.now() - 3600000).toISOString() // 1 hour ago
      },
      {
        id: 1002,
        documentName: 'Content_Guidelines_Draft.docx',
        method: 'Review Content',
        status: 'Reviewing Content',
        timestamp: new Date(Date.now() - 300000).toISOString() // 5 minutes ago
      },
      {
        id: 1003,
        documentName: 'Accessibility_Report_2026.pdf',
        method: 'Review Content',
        status: 'Queued',
        timestamp: new Date(Date.now() - 120000).toISOString() // 2 minutes ago
      },
      {
        id: 1004,
        documentName: 'User_Journey_Documentation.docx',
        method: 'Review Content',
        status: 'Uploading',
        timestamp: new Date(Date.now() - 30000).toISOString() // 30 seconds ago
      },
      {
        id: 1005,
        documentName: 'Policy_Update_Jan2026.pdf',
        method: 'Review Content',
        status: 'Completed',
        timestamp: new Date(Date.now() - 7200000).toISOString() // 2 hours ago
      },
      {
        id: 1006,
        documentName: 'Service_Assessment_Notes.docx',
        method: 'Review Content',
        status: 'Failed',
        timestamp: new Date(Date.now() - 1800000).toISOString() // 30 minutes ago
      }
    ];

    // Load review history from localStorage, or use default if not present
    let reviewHistory = [];
    try {
      const stored = localStorage.getItem('reviewHistory');
      if (stored) {
        reviewHistory = JSON.parse(stored);
        // Convert timestamp strings back to Date objects
        reviewHistory.forEach(item => {
          item.timestamp = new Date(item.timestamp);
        });
      } else {
        // First time loading - use default data
        reviewHistory = defaultReviewHistory.map(item => ({
          ...item,
          timestamp: new Date(item.timestamp)
        }));
        // Save to localStorage
        localStorage.setItem('reviewHistory', JSON.stringify(reviewHistory));
      }
    } catch (e) {
      console.error('Error loading review history from localStorage:', e);
      // Fallback to default data
      reviewHistory = defaultReviewHistory.map(item => ({
        ...item,
        timestamp: new Date(item.timestamp)
      }));
    }

    // Function to save review history to localStorage
    function saveReviewHistory() {
      try {
        localStorage.setItem('reviewHistory', JSON.stringify(reviewHistory));
      } catch (e) {
        console.error('Error saving review history to localStorage:', e);
      }
    }

    // Function to get status tag class
    function getStatusTagClass(status) {
      const statusClasses = {
        'Uploading': 'govuk-tag--blue',
        'Queued': 'govuk-tag--yellow',
        'Reviewing Content': 'govuk-tag--purple',
        'Completed': 'govuk-tag--green',
        'Failed': 'govuk-tag--red'
      };
      return statusClasses[status] || '';
    }

    // Function to format timestamp
    function formatTimestamp(date) {
      return new Date(date).toLocaleString('en-GB', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // Function to render review history table
    function renderReviewHistory() {
      console.log('renderReviewHistory called, reviewHistory length:', reviewHistory.length);
      const tbody = document.getElementById('reviewHistoryBody');
      console.log('tbody element:', tbody);
      
      if (!tbody) {
        console.error('reviewHistoryBody element not found!');
        return;
      }
      
      if (reviewHistory.length === 0) {
        tbody.innerHTML = `
          <tr class="govuk-table__row">
            <td class="govuk-table__cell" colspan="5">
              <p class="govuk-body">No documents uploaded yet.</p>
            </td>
          </tr>
        `;
        return;
      }

      console.log('Rendering', reviewHistory.length, 'items');
      tbody.innerHTML = reviewHistory.map(item => {
        let resultCell;
        
        switch(item.status) {
          case 'Completed':
            resultCell = `<a href="/review/results/${item.id}" class="govuk-link">View results</a>`;
            break;
          case 'Failed':
            resultCell = '<span class="govuk-error-message">Review failed</span>';
            break;
          case 'Uploading':
            resultCell = '<span class="govuk-hint">Uploading to S3...</span>';
            break;
          case 'Queued':
            resultCell = '<span class="govuk-hint">In SQS queue...</span>';
            break;
          case 'Reviewing Content':
            resultCell = '<span class="govuk-hint">LLM processing...</span>';
            break;
          default:
            resultCell = '<span class="govuk-hint">Processing...</span>';
        }
        
        return `
          <tr class="govuk-table__row">
            <td class="govuk-table__cell">${item.documentName}</td>
            <td class="govuk-table__cell">${item.method}</td>
            <td class="govuk-table__cell">
              <strong class="govuk-tag ${getStatusTagClass(item.status)}">${item.status}</strong>
            </td>
            <td class="govuk-table__cell">${formatTimestamp(item.timestamp)}</td>
            <td class="govuk-table__cell">${resultCell}</td>
          </tr>
        `;
      }).join('');
    }

    // Handle unified review form
    document.getElementById('reviewForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const fileInput = document.getElementById('file-upload');
      const contentInput = document.getElementById('userInput');
      const file = fileInput.files[0];
      const content = contentInput.value.trim();
      
      // Check if either file or content is provided
      if (!file && !content) {
        alert('Please either upload a file or enter content to review');
        return;
      }

      const reviewId = Date.now();
      let documentName, method, initialStatus;

      // Determine what's being reviewed
      if (file) {
        documentName = file.name;
        method = 'Review Content';
        initialStatus = 'Uploading';
      } else {
        const preview = content.substring(0, 50) + (content.length > 50 ? '...' : '');
        documentName = `Text: "${preview}"`;
        method = 'Review Content';
        initialStatus = 'Uploading';
      }

      // Add to review history immediately with "Uploading" status
      reviewHistory.unshift({
        id: reviewId,
        documentName: documentName,
        method: method,
        status: initialStatus,
        timestamp: new Date()
      });
      saveReviewHistory();
      renderReviewHistory();

      // Upload file to backend (LocalStack S3)
      if (file) {
        try {
          console.log('Uploading file to backend:', file.name);
          
          const formData = new FormData();
          formData.append('file', file);
          
          // Upload to backend API
          const response = await fetch(window.APP_CONFIG.backendApiUrl + '/api/upload', {
            method: 'POST',
            body: formData
          });

          if (!response.ok) {
            throw new Error(`Upload failed: ${response.statusText}`);
          }

          const result = await response.json();
          console.log('Upload successful:', result);
          
          // Update the review history item with backend data
          const item = reviewHistory.find(r => r.id === reviewId);
          if (item && result.uploadId) {
            item.id = result.uploadId; // Use backend-generated ID
            item.s3Location = result.s3Location;
            item.backendData = result;
          }
          
        } catch (error) {
          console.error('Error uploading file to backend:', error);
          // Update status to Failed
          const item = reviewHistory.find(r => r.id === reviewId);
          if (item) {
            item.status = 'Failed';
            saveReviewHistory();
            renderReviewHistory();
          }
          alert('File upload failed: ' + error.message);
          return;
        }
      }

      // Continue workflow simulation (status progression)
      // 1. S3 upload done, now queued for processing
      setTimeout(() => {
        const item = reviewHistory.find(r => r.id === reviewId);
        if (item && item.status !== 'Failed') {
          item.status = 'Queued'; // 2. Message sent to SQS queue
          saveReviewHistory();
          renderReviewHistory();
        }
      }, 2000);

      // 3. SQS Orchestrator picks up the message and processes
      setTimeout(() => {
        const item = reviewHistory.find(r => r.id === reviewId);
        if (item && item.status !== 'Failed') {
          item.status = 'Reviewing Content'; // 4. LLM is reviewing the content
          saveReviewHistory();
          renderReviewHistory();
        }
      }, 4000);

      // 5. LLM completes review and saves result to S3
      // 6. Result is now available in Web UI
      setTimeout(() => {
        const item = reviewHistory.find(r => r.id === reviewId);
        if (item && item.status !== 'Failed') {
          item.status = 'Completed';
          saveReviewHistory();
          renderReviewHistory();
          
          // Only clear the file input after LLM evaluation is complete
          if (file) {
            fileInput.value = '';
          }
        }
      }, 8000);

      // Clear text content immediately, but keep filename until completion
      contentInput.value = '';
    });

    // Reset demo data button handler
    document.getElementById('resetHistoryBtn').addEventListener('click', () => {
      if (confirm('This will reset the review history to the original demo data. Continue?')) {
        localStorage.removeItem('reviewHistory');
        location.reload();
      }
    });

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeReviewHistory);
    } else {
      // DOM already loaded
      initializeReviewHistory();
    }

    function initializeReviewHistory() {
      console.log('Initializing review history...');
      
      // Check for upload success message from sessionStorage
      const uploadSuccess = sessionStorage.getItem('uploadSuccess');
      if (uploadSuccess) {
        try {
          const data = JSON.parse(uploadSuccess);
          
          // Add to review history
          reviewHistory.unshift({
            id: data.fileId,
            documentName: data.filename,
            method: 'File Upload',
            status: 'Completed',
            timestamp: new Date()
          });
          
          saveReviewHistory();
          
          // Clear from sessionStorage
          sessionStorage.removeItem('uploadSuccess');
        } catch (e) {
          console.error('Error parsing upload success:', e);
        }
      }

      // Initial render - always show the dummy data
      console.log('About to render review history with', reviewHistory.length, 'items');
      renderReviewHistory();

      // Auto-simulate status progression for demo purposes
      // This simulates the workflow: Uploading → Queued → Reviewing Content → Completed
      // Note: Only progresses items that are in intermediate states, not final states (Completed/Failed)
      setInterval(() => {
        let updated = false;
        
        reviewHistory.forEach(item => {
          // Only progress if not in a final state
          if (item.status === 'Uploading') {
            item.status = 'Queued';
            updated = true;
          } else if (item.status === 'Queued') {
            item.status = 'Reviewing Content';
            updated = true;
          } else if (item.status === 'Reviewing Content') {
            item.status = 'Completed';
            updated = true;
          }
          // Do not modify 'Completed' or 'Failed' states - they are final
        });
        
        if (updated) {
          console.log('Status updated, re-rendering...');
          saveReviewHistory();
          renderReviewHistory();
        }
      }, 10000); // Check every 10 seconds for demo
    }
  </script>
  {{ super() }}
{% endblock %}
