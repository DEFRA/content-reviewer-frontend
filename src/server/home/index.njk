{% extends 'layouts/page.njk' %}

{% block head %}
  {{ super() }}
  <style nonce="{{ cspNonce }}">
    /* Animated loading dots */
    .loading-dots {
      display: inline-block;
      margin-left: 2px;
    }
    
    .loading-dots span {
      animation: blink 1.4s infinite;
      animation-fill-mode: both;
    }
    
    .loading-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .loading-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes blink {
      0%, 80%, 100% {
        opacity: 0;
      }
      40% {
        opacity: 1;
      }
    }
    
    /* Upload progress bar */
    .upload-progress-bar {
      background: #1d70b8;
      height: 10px;
      border-radius: 5px;
      transition: width 0.3s ease;
      width: 0%;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      
      <h1 class="govuk-heading-l">Content Review Assistant</h1>
      
      <!-- Upload Success Message -->
      {% if uploadSuccess %}
      <div class="govuk-notification-banner govuk-notification-banner--success" role="alert" aria-labelledby="upload-success-title" data-module="govuk-notification-banner">
        <div class="govuk-notification-banner__header">
          <h2 class="govuk-notification-banner__title" id="upload-success-title">
            Success
          </h2>
        </div>
        <div class="govuk-notification-banner__content">
          <h3 class="govuk-notification-banner__heading">
            Document uploaded successfully
          </h3>
          <p class="govuk-body">
            <strong>{{ uploadSuccess.filename }}</strong> ({{ (uploadSuccess.size / 1024) | round(2) }} KB) has been uploaded and scanned.
          </p>
        </div>
      </div>
      {% endif %}

      <!-- Upload Error Message -->
      {% if uploadError %}
      <div class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert" tabindex="-1" data-module="govuk-error-summary">
        <h2 class="govuk-error-summary__title" id="error-summary-title">
          Upload failed
        </h2>
        <div class="govuk-error-summary__body">
          <p class="govuk-body">{{ uploadError }}</p>
        </div>
      </div>
      {% endif %}

      <p class="govuk-body">
        Upload a document or paste content below for review. The content will be analyzed for clarity, formatting and compliance with GOV.UK standards.
      </p>

      <!-- Content Review Form -->
      <div class="govuk-!-margin-bottom-6">
        <form id="uploadForm" enctype="multipart/form-data">
          
          <!-- Upload Error Message (Dynamic) -->
          <div id="uploadError" class="govuk-error-summary" hidden aria-labelledby="error-summary-title" role="alert" tabindex="-1">
            <h2 class="govuk-error-summary__title" id="error-summary-title">
              Upload failed
            </h2>
            <div class="govuk-error-summary__body">
              <p class="govuk-body" id="errorMessage"></p>
            </div>
          </div>

          <!-- Upload Success Message (Dynamic) -->
          <div id="uploadSuccess" class="govuk-notification-banner govuk-notification-banner--success" role="alert" hidden>
            <div class="govuk-notification-banner__header">
              <h2 class="govuk-notification-banner__title">Success</h2>
            </div>
            <div class="govuk-notification-banner__content">
              <p class="govuk-body" id="successMessage"></p>
            </div>
          </div>

          <!-- File Upload Option -->
          <div class="govuk-form-group" id="fileFormGroup">
            <label class="govuk-label govuk-label--s" for="file-upload">
              Upload a document (optional)
            </label>
            <div class="govuk-hint">
              Accepted file types: PDF (.pdf), Word (.doc, .docx). Maximum file size: 10MB
            </div>
            <input class="govuk-file-upload" id="file-upload" name="file" type="file" accept=".pdf,.doc,.docx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
            <div id="file-name-display" class="govuk-hint govuk-!-margin-top-2 js-hidden">
              Selected: <strong id="selected-file-name"></strong>
            </div>
          </div>

          <!-- Text Content Option -->
          <div class="govuk-form-group" id="textFormGroup">
            <label class="govuk-label govuk-label--s" for="text-content">
              Or type/paste your content directly
            </label>
            <textarea 
              class="govuk-textarea" 
              id="text-content" 
              name="textContent" 
              rows="8" 
              placeholder="Type or paste content here..."
              aria-describedby="text-content-hint"
            ></textarea>
          </div>
          
          <button 
            type="submit" 
            class="govuk-button"
            data-module="govuk-button"
            id="uploadButton"
          >
            Review Content
          </button>

          <!-- Upload Progress Indicator -->
          <div id="uploadProgress" class="govuk-!-margin-top-4" hidden>
            <div class="govuk-inset-text">
              <p class="govuk-body" id="uploadStatusText"></p>
              <div class="govuk-!-margin-top-2">
                <div id="progressBar" class="upload-progress-bar" data-progress="0"></div>
                <p class="govuk-body govuk-!-margin-top-1" id="uploadProgressText"></p>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Document Review History Table -->
      <div class="govuk-grid-row govuk-!-margin-top-8">
        <div class="govuk-grid-column-one-half">
          <h2 class="govuk-heading-m">Review History</h2>
        </div>
        <div class="govuk-grid-column-one-half" style="text-align: right;">
          <div class="govuk-form-group" style="margin-bottom: 0;">
            <label class="govuk-label" for="reviewLimit" style="display: inline-block; margin-right: 10px;">
              Show:
            </label>
            <select class="govuk-select" id="reviewLimit" name="reviewLimit" style="width: auto; display: inline-block;">
              <option value="20" selected>20 reviews</option>
              <option value="100">100 reviews</option>
            </select>
          </div>
        </div>
      </div>
        
      <table class="govuk-table" id="reviewHistoryTable">
        <thead class="govuk-table__head">
          <tr class="govuk-table__row">
            <th scope="col" class="govuk-table__header">Uploaded Document</th>
            <th scope="col" class="govuk-table__header">Method</th>
            <th scope="col" class="govuk-table__header">Status</th>
            <th scope="col" class="govuk-table__header">Timestamp</th>
            <th scope="col" class="govuk-table__header">Result</th>
          </tr>
        </thead>
        <tbody class="govuk-table__body" id="reviewHistoryBody">
          {% if reviewHistory and reviewHistory.length > 0 %}
            {% for review in reviewHistory %}
            <tr class="govuk-table__row">
              <td class="govuk-table__cell">{{ review.filename }}</td>
              <td class="govuk-table__cell">Review Content</td>
              <td class="govuk-table__cell">
                {% if review.status === 'completed' %}
                  <strong class="govuk-tag govuk-tag--green">Completed</strong>
                {% elif review.status === 'processing' or review.status === 'analyzing' or review.status === 'reviewing' %}
                  <strong class="govuk-tag govuk-tag--blue">{{ review.status | title }}<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span></strong>
                {% elif review.status === 'queued' %}
                  <strong class="govuk-tag govuk-tag--yellow">Queued<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span></strong>
                {% elif review.status === 'uploading' or review.status === 'uploaded' %}
                  <strong class="govuk-tag govuk-tag--grey">{{ review.status | title }}<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span></strong>
                {% elif review.status === 'failed' %}
                  <strong class="govuk-tag govuk-tag--red">Failed</strong>
                {% else %}
                  <strong class="govuk-tag govuk-tag--grey">{{ review.status | title }}</strong>
                {% endif %}
              </td>
              <td class="govuk-table__cell">
                {% if review.uploadedAt %}
                  {{ review.uploadedAt | formatDate('dd/MM/yyyy, HH:mm') }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td class="govuk-table__cell">
                {% if review.status === 'completed' %}
                  <a href="/review/results/{{ review.reviewId }}" class="govuk-link">View results</a>
                {% elif review.status === 'failed' %}
                  <span class="govuk-error-message">Review failed</span>
                {% elif review.status === 'processing' or review.status === 'analyzing' or review.status === 'reviewing' %}
                  <span class="govuk-body">{{ review.status | title }}<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span></span>
                {% elif review.status === 'queued' %}
                  <span class="govuk-body">Queued<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span></span>
                {% elif review.status === 'uploading' or review.status === 'uploaded' %}
                  <span class="govuk-body">{{ review.status | title }}<span class="loading-dots"><span>.</span><span>.</span><span>.</span></span></span>
                {% else %}
                  <span class="govuk-body">{{ review.status }}</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr class="govuk-table__row">
              <td class="govuk-table__cell" colspan="5">
                <p class="govuk-body">No review history available.</p>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>

    </div>
  </div>

{% endblock %}

{% block bodyEnd %}
  {{ super() }}
  <script nonce="{{ cspNonce }}" src="{{ getAssetPath('upload-handler.js') }}"></script>
  <script nonce="{{ cspNonce }}">
    console.log('[HOME] Page loaded at', new Date().toISOString());
    console.log('[HOME] Backend URL:', window.APP_CONFIG?.backendApiUrl);
    console.log('[HOME] Cache buster:', '{{ cacheBuster }}');
    
    // ============ AUTO-REFRESH LOGIC ============
    // Note: Upload form handling is now in upload-handler.js
    // Auto-refresh state
    let autoRefreshInterval = null;
    let isRefreshing = false;
    
    // Get the current limit from dropdown
    function getCurrentLimit() {
      const limitSelect = document.getElementById('reviewLimit');
      return parseInt(limitSelect?.value || '20');
    }
    
    // Add event listener to dropdown
    const limitSelect = document.getElementById('reviewLimit');
    if (limitSelect) {
      limitSelect.addEventListener('change', async function() {
        console.log('Review limit changed to:', this.value);
        await updateReviewHistory();
      });
    }
    
    // Function to update review history without page reload
    async function updateReviewHistory() {
      if (isRefreshing) return; // Prevent concurrent requests
      
      isRefreshing = true;
      try {
        const backendUrl = window.APP_CONFIG?.backendApiUrl || 'http://localhost:3001';
        const limit = getCurrentLimit();
        const response = await fetch(`${backendUrl}/api/reviews?limit=${limit}`, {
          method: 'GET',
          headers: {
            'Accept': 'application/json'
          }
        })
        
        if (!response.ok) {
          console.error('Failed to fetch review history: HTTP', response.status);
          // Stop auto-refresh on error to prevent spam
          if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
            console.log('Auto-refresh stopped due to fetch error');
          }
          return;
        }
        
        const data = await response.json();
        console.log('Review history updated:', data.reviews ? data.reviews.length : 0, 'items');
        
        // Update the table
        updateReviewTable(data.reviews || []);
        
        // Check if there are still active reviews
        const hasActiveReviews = data.reviews.some(r => 
          ['processing', 'analyzing', 'queued', 'reviewing', 'downloading', 'finalizing', 'uploaded', 'uploading'].includes(r.status)
        );
        
        // Hide success message if no active reviews (all completed)
        if (!hasActiveReviews && uploadSuccess) {
          uploadSuccess.hidden = true;
        }
        
        // Stop auto-refresh if no active reviews
        if (!hasActiveReviews && autoRefreshInterval) {
          console.log('No more active reviews - doing one final refresh in 3 seconds before stopping auto-refresh');
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
          setTimeout(async () => {
            await updateReviewHistory();
            // After final refresh, check again for active reviews
            const stillActive = (window.lastReviewData || []).some(r => 
              ['processing', 'analyzing', 'queued', 'reviewing', 'downloading', 'finalizing', 'uploaded', 'uploading'].includes(r.status)
            );
            if (stillActive) {
              // If still active, restart auto-refresh
              startAutoRefresh();
            } else {
              console.log('Final refresh done, auto-refresh stopped.');
            }
          }, 3000);
        }
        // Store last review data for re-check
        window.lastReviewData = data.reviews || [];
        
      } catch (error) {
        console.error('Error updating review history:', error);
        // Stop auto-refresh on network error to prevent continuous failed requests
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
          console.log('Auto-refresh stopped due to network error');
        }
      } finally {
        isRefreshing = false;
      }
    }
    
    // Helper function to create loading dots using DOM (CSP-compliant)
    function createLoadingDots() {
      const container = document.createElement('span');
      container.className = 'loading-dots';
      
      for (let i = 0; i < 3; i++) {
        const dot = document.createElement('span');
        dot.textContent = '.';
        container.appendChild(dot);
      }
      
      return container;
    }
    
    // Helper to create status content with loading dots (CSP-compliant)
    function createStatusContent(cell, status) {
      const statusLower = (status || '').toLowerCase();
      
      if (['processing', 'analyzing', 'reviewing'].includes(statusLower)) {
        const textNode = document.createTextNode(status.charAt(0).toUpperCase() + status.slice(1));
        cell.appendChild(textNode);
        cell.appendChild(createLoadingDots());
      } else if (statusLower === 'queued') {
        const textNode = document.createTextNode('Queued');
        cell.appendChild(textNode);
        cell.appendChild(createLoadingDots());
      } else if (['uploading', 'uploaded'].includes(statusLower)) {
        const textNode = document.createTextNode(status.charAt(0).toUpperCase() + status.slice(1));
        cell.appendChild(textNode);
        cell.appendChild(createLoadingDots());
      } else {
        cell.textContent = status.charAt(0).toUpperCase() + status.slice(1);
      }
    }
    
    // Update the review table with new data
    function updateReviewTable(reviews) {
      const tbody = document.getElementById('reviewHistoryBody');
      
      if (!reviews || reviews.length === 0) {
        tbody.innerHTML = '<tr class="govuk-table__row"><td class="govuk-table__cell" colspan="5"><p class="govuk-body">No review history available.</p></td></tr>';
        return;
      }
      
      tbody.innerHTML = '';
      
      reviews.forEach(review => {
        const row = document.createElement('tr');
        row.className = 'govuk-table__row';
        
        // Filename
        const filenameCell = document.createElement('td');
        filenameCell.className = 'govuk-table__cell';
        filenameCell.textContent = review.filename || 'N/A';
        row.appendChild(filenameCell);
        
        // Method
        const methodCell = document.createElement('td');
        methodCell.className = 'govuk-table__cell';
        methodCell.textContent = 'Review Content';
        row.appendChild(methodCell);
        
        // Status
        const statusCell = document.createElement('td');
        statusCell.className = 'govuk-table__cell';
        const statusTag = document.createElement('strong');
        statusTag.className = 'govuk-tag';
        
        const status = (review.status || '').toLowerCase();
        if (status === 'completed') {
          statusTag.classList.add('govuk-tag--green');
          statusTag.textContent = 'Completed';
        } else if (['processing', 'analyzing', 'reviewing'].includes(status)) {
          statusTag.classList.add('govuk-tag--blue');
          createStatusContent(statusTag, review.status);
        } else if (status === 'queued') {
          statusTag.classList.add('govuk-tag--yellow');
          createStatusContent(statusTag, 'Queued');
        } else if (['uploading', 'uploaded'].includes(status)) {
          statusTag.classList.add('govuk-tag--grey');
          createStatusContent(statusTag, review.status);
        } else if (status === 'failed') {
          statusTag.classList.add('govuk-tag--red');
          statusTag.textContent = 'Failed';
        } else {
          statusTag.classList.add('govuk-tag--grey');
          statusTag.textContent = review.status ? review.status.charAt(0).toUpperCase() + review.status.slice(1) : 'Unknown';
        }
        
        statusCell.appendChild(statusTag);
        row.appendChild(statusCell);
        
        // Timestamp
        const timestampCell = document.createElement('td');
        timestampCell.className = 'govuk-table__cell';
        if (review.uploadedAt) {
          const date = new Date(review.uploadedAt);
          timestampCell.textContent = date.toLocaleString('en-GB', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        } else {
          timestampCell.textContent = 'N/A';
        }
        row.appendChild(timestampCell);
        
        // Result
        const resultCell = document.createElement('td');
        resultCell.className = 'govuk-table__cell';
        
        if (status === 'completed') {
          const link = document.createElement('a');
          link.href = `/review/results/${review.reviewId}`;
          link.className = 'govuk-link';
          link.textContent = 'View results';
          resultCell.appendChild(link);
        } else if (status === 'failed') {
          const errorSpan = document.createElement('span');
          errorSpan.className = 'govuk-error-message';
          errorSpan.textContent = 'Review failed';
          resultCell.appendChild(errorSpan);
        } else if (['processing', 'analyzing', 'reviewing'].includes(status)) {
          const span = document.createElement('span');
          span.className = 'govuk-body';
          createStatusContent(span, review.status);
          resultCell.appendChild(span);
        } else if (status === 'queued') {
          const span = document.createElement('span');
          span.className = 'govuk-body';
          createStatusContent(span, 'Queued');
          resultCell.appendChild(span);
        } else if (['uploading', 'uploaded'].includes(status)) {
          const span = document.createElement('span');
          span.className = 'govuk-body';
          createStatusContent(span, review.status);
          resultCell.appendChild(span);
        } else {
          resultCell.textContent = review.status || 'Unknown';
        }
        
        row.appendChild(resultCell);
        tbody.appendChild(row);
      });
    }
    
    // Start auto-refresh
    function startAutoRefresh() {
      if (autoRefreshInterval) return; // Already running
      
      console.log('[HOME] Starting auto-refresh...');
      autoRefreshInterval = setInterval(updateReviewHistory, 5000);
    }
    
    // Check if there are any active reviews on page load
    const tableRows = document.querySelectorAll('#reviewHistoryBody tr');
    let hasActiveReviews = false;
    
    tableRows.forEach(row => {
      const statusCell = row.querySelector('.govuk-tag');
      if (statusCell && (
        statusCell.classList.contains('govuk-tag--blue') ||
        statusCell.classList.contains('govuk-tag--yellow') ||
        statusCell.classList.contains('govuk-tag--grey')
      )) {
        hasActiveReviews = true;
      }
    });
    
    // Start auto-refresh if there are active reviews
    if (hasActiveReviews) {
      console.log('[HOME] Active reviews detected, starting auto-refresh');
      startAutoRefresh();
    }
    
    // Clean up interval when page is unloaded
    window.addEventListener('beforeunload', () => {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
    });
  </script>
{% endblock %}
