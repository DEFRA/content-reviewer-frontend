{% extends 'layouts/page.njk' %}

{% block head %}
  {{ super() }}
  <style nonce="{{ cspNonce }}">
    /* Animated loading dots */
    .loading-dots {
      display: inline-block;
      margin-left: 2px;
    }
    .loading-dots span {
      animation: blink 1.4s infinite;
      animation-fill-mode: both;
    }
    .loading-dots span:nth-child(2) {
      animation-delay: 0.2s;
    }
    .loading-dots span:nth-child(3) {
      animation-delay: 0.4s;
    }
    @keyframes blink {
      0%, 80%, 100% { opacity: 0; }
      40% { opacity: 1; }
    }
    .upload-progress-bar {
      background: #1d70b8;
      height: 10px;
      border-radius: 5px;
      transition: width 0.3s ease;
      width: 0%;
    }
    .text-align-right { text-align: right; }
    .margin-bottom-0 { margin-bottom: 0; }
    .inline-block { display: inline-block; }
    .margin-right-10 { margin-right: 10px; }
    .width-auto { width: auto; }
    .display-inline { display: inline; }
  </style>
{% endblock %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      
      <h1 class="govuk-heading-l">Content Review Assistant</h1>
      
      <!-- Upload Success Message -->
      {% if uploadSuccess %}
      <div class="govuk-notification-banner govuk-notification-banner--success" role="alert" aria-labelledby="upload-success-title" data-module="govuk-notification-banner">
        <div class="govuk-notification-banner__header">
          <h2 class="govuk-notification-banner__title" id="upload-success-title">
            Success
          </h2>
        </div>
        <div class="govuk-notification-banner__content">
          <h3 class="govuk-notification-banner__heading">
            Document uploaded successfully
          </h3>
          <p class="govuk-body">
            <strong>{{ uploadSuccess.filename }}</strong> ({{ (uploadSuccess.size / 1024) | round(2) }} KB) has been uploaded and scanned.
          </p>
        </div>
      </div>
      {% endif %}

      <!-- Upload Error Message -->
      {% if uploadError %}
      <div class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert" tabindex="-1" data-module="govuk-error-summary">
        <h2 class="govuk-error-summary__title" id="error-summary-title">
          Upload failed
        </h2>
        <div class="govuk-error-summary__body">
          <p class="govuk-body">{{ uploadError }}</p>
        </div>
      </div>
      {% endif %}

      <p class="govuk-body">
        Type or paste content below for review. The content will be analyzed for clarity, formatting and compliance with GOV.UK standards.
      </p>

      <!-- Content Review Form -->
      <div class="govuk-!-margin-bottom-6">
        <form id="uploadForm" enctype="multipart/form-data">
          
          <!-- Upload Error Message (Dynamic) -->
          <div id="uploadError" class="govuk-error-summary" hidden aria-labelledby="error-summary-title" role="alert" tabindex="-1">
            <h2 class="govuk-error-summary__title" id="error-summary-title">
              Upload failed
            </h2>
            <div class="govuk-error-summary__body">
              <p class="govuk-body" id="errorMessage"></p>
            </div>
          </div>

          <!-- Upload Success Message (Dynamic) -->
          <div id="uploadSuccess" class="govuk-notification-banner govuk-notification-banner--success" role="alert" hidden>
            <div class="govuk-notification-banner__header">
              <h2 class="govuk-notification-banner__title">Success</h2>
            </div>
            <div class="govuk-notification-banner__content">
              <p class="govuk-body" id="successMessage"></p>
            </div>
          </div>

          <!-- File Upload Option - COMMENTED OUT - File upload functionality disabled for demo -->
          <!-- <div class="govuk-form-group" id="fileFormGroup">
            <label class="govuk-label govuk-label--s" for="file-upload">
              Upload a document (optional)
            </label>
            <div class="govuk-hint">
              Accepted file types: PDF (.pdf), Word (.doc, .docx). Maximum file size: 10MB
            </div>
            <input class="govuk-file-upload" id="file-upload" name="file" type="file" accept=".pdf,.doc,.docx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
            <div id="file-name-display" class="govuk-hint govuk-!-margin-top-2 js-hidden">
              Selected: <strong id="selected-file-name"></strong>
            </div>
          </div> -->

          <!-- Text Content Option -->
          <div class="govuk-form-group" id="textFormGroup">
            <label class="govuk-label govuk-label--s" for="text-content">
              Type/paste your content directly
            </label>
            <textarea 
              class="govuk-textarea" 
              id="text-content" 
              name="textContent" 
              rows="8" 
              placeholder="Type or paste content here..."
              aria-describedby="text-content-hint"
            ></textarea>
          </div>
          
          <button 
            type="submit" 
            class="govuk-button"
            data-module="govuk-button"
            id="uploadButton"
          >
            Review Content
          </button>

          <!-- Upload Progress Indicator -->
          <div id="uploadProgress" class="govuk-!-margin-top-4" hidden>
            <div class="govuk-inset-text">
              <p class="govuk-body" id="uploadStatusText"></p>
              <div class="govuk-!-margin-top-2">
                <div id="progressBar" class="upload-progress-bar" data-progress="0"></div>
                <p class="govuk-body govuk-!-margin-top-1" id="uploadProgressText"></p>
              </div>
            </div>
          </div>
        </form>
      </div>

      <!-- Document Review History Table -->
      <div class="govuk-grid-row govuk-!-margin-top-8">
        <div class="govuk-grid-column-one-half">
          <h2 class="govuk-heading-m">Review History</h2>
        </div>
        <div class="govuk-grid-column-one-half text-align-right">
          <form id="reviewLimitForm" method="get" class="display-inline">
            <label class="govuk-label inline-block margin-right-10" for="reviewLimit">
              Show:
            </label>
            <select class="govuk-select width-auto inline-block" id="reviewLimit" name="limit">
              <option value="5" {% if (currentLimit == 5) %}selected{% endif %}>5 reviews</option>
              <option value="10" {% if (currentLimit == 10) %}selected{% endif %}>10 reviews</option>
              <option value="50" {% if (currentLimit == 50) %}selected{% endif %}>50 reviews</option>
            </select>
          </form>
        </div>
      </div>
        
      <table class="govuk-table" id="reviewHistoryTable">
        <thead class="govuk-table__head">
          <tr class="govuk-table__row">
            <th scope="col" class="govuk-table__header">Uploaded Document</th>
            <th scope="col" class="govuk-table__header">Status</th>
            <th scope="col" class="govuk-table__header">Timestamp</th>
            <th scope="col" class="govuk-table__header">Result</th>
          </tr>
        </thead>
        <tbody class="govuk-table__body" id="reviewHistoryBody">
          {% if reviewHistory and reviewHistory.length > 0 %}
            {% for review in reviewHistory %}
            <tr class="govuk-table__row">
              <td class="govuk-table__cell">{{ review.filename }}</td>
              <td class="govuk-table__cell">
                {% if review.status === 'completed' %}
                  <strong class="govuk-tag govuk-tag--green">Completed</strong>
                {% elif review.status === 'processing' %}
                  <strong class="govuk-tag govuk-tag--blue">Processing...</strong>
                {% elif review.status === 'pending' %}
                  <strong class="govuk-tag govuk-tag--yellow">Pending...</strong>
                {% elif review.status === 'failed' %}
                  <strong class="govuk-tag govuk-tag--red">Failed</strong>
                {% else %}
                  <strong class="govuk-tag govuk-tag--grey">{{ review.status | title }}</strong>
                {% endif %}
              </td>
              <td class="govuk-table__cell">
                {% if review.uploadedAt %}
                  {{ review.uploadedAt | formatDate('dd/MM/yyyy, HH:mm') }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td class="govuk-table__cell">
                {% if review.status === 'completed' %}
                  {% if review.reviewId or review.id %}
                    <a href="/review/results/{{ review.reviewId or review.id }}" class="govuk-link">View results</a>
                  {% else %}
                    <span class="govuk-hint">Missing review ID</span>
                  {% endif %}
                {% elif review.status === 'failed' %}
                  <span class="govuk-error-message">Review failed</span>
                {% elif review.status === 'processing' %}
                  <span class="govuk-body">Processing...</span>
                {% elif review.status === 'pending' %}
                  <span class="govuk-body">Pending...</span>
                {% else %}
                  <span class="govuk-body">{{ review.status }}</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr class="govuk-table__row">
              <td class="govuk-table__cell" colspan="5">
                <p class="govuk-body">No review history available.</p>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>

    </div>
  </div>

{% endblock %}

{% block bodyEnd %}
  {{ super() }}
  <script nonce="{{ cspNonce }}" src="{{ getAssetPath('upload-handler.js') }}"></script>
  <script nonce="{{ cspNonce }}">
    console.log('[HOME] Page loaded at', new Date().toISOString());
    console.log('[HOME] Backend URL:', window.APP_CONFIG?.backendApiUrl);
    console.log('[HOME] Cache buster:', '{{ cacheBuster }}');
    // ============ AUTO-REFRESH LOGIC ============
    // Note: Upload form handling is now in upload-handler.js
    // Auto-refresh state
    let autoRefreshInterval = null;
    let isRefreshing = false;
    
    // Get the current limit from dropdown
    function getCurrentLimit() {
      const limitSelect = document.getElementById('reviewLimit');
      return parseInt(limitSelect?.value, 5);
    }
    
    // Add event listener to dropdown
    const limitSelect = document.getElementById('reviewLimit');
    if (limitSelect) {
      limitSelect.addEventListener('change', function() {
        console.log('Review limit changed to:', this.value);
        this.form.submit();
      });
    }
    
    // Function to update review history without page reload
    async function updateReviewHistory() {
      if (isRefreshing) return; // Prevent concurrent requests
      
      isRefreshing = true;
      try {
        const limit = document.getElementById('reviewLimit')?.value || 5;
        // Call frontend proxy route instead of backend directly to avoid CORS issues
        const response = await fetch(`/api/reviews?limit=${limit}`, {
          method: 'GET',
          headers: {
            'Accept': 'application/json'
          }
        })
        
        if (!response.ok) {
          console.error('Failed to fetch review history: HTTP', response.status);
          // Stop auto-refresh on error to prevent spam
          if (autoRefreshInterval) {
            clearInterval(autoRefreshInterval);
            autoRefreshInterval = null;
            console.log('Auto-refresh stopped due to fetch error');
          }
          return;
        }
        
        const data = await response.json();
        console.log('[HOME] Review history updated:', { 
          count: data.reviews ? data.reviews.length : 0,
          reviews: data.reviews 
        });
        
        // Log raw backend data to debug fileName issues
        console.log('[HOME] Raw review data from backend:', data.reviews.map(r => ({
          id: r.id,
          fileName: r.fileName,
          filename: r.filename,
          status: r.status,
          createdAt: r.createdAt,
          uploadedAt: r.uploadedAt,
          updatedAt: r.updatedAt,
          hasCreatedAt: !!r.createdAt,
          hasUploadedAt: !!r.uploadedAt,
          hasUpdatedAt: !!r.updatedAt
        })));
        
        // Normalize review data for client-side rendering
        const normalized = (data.reviews || []).map(r => {
          // Determine filename - preserve the original if it exists
          let displayFilename = r.fileName || r.filename;
          
          // If fileName/filename is missing or empty for text content, use first 10 chars
          if (!displayFilename || displayFilename === 'Text Content') {
            // Try to get from content if available, otherwise keep 'Text Content'
            displayFilename = r.fileName || r.filename || 'Text Content';
          }
          
          return {
            ...r,
            filename: displayFilename,
            uploadedAt: r.uploadedAt || r.createdAt || r.updatedAt || null
          };
        });
        
        console.log('[HOME] Normalized reviews:', normalized.map(r => ({ 
          id: r.id || r.reviewId, 
          filename: r.filename, 
          status: r.status,
          uploadedAt: r.uploadedAt,
          createdAt: r.createdAt,
          updatedAt: r.updatedAt
        })));

        // Update the table
        updateReviewTable(normalized);
        
        // Check if there are still active reviews (not completed or failed)
        const hasActiveReviews = normalized.some(r => {
          const status = (r.status || '').toLowerCase();
          return ['processing', 'analyzing', 'queued', 'reviewing', 'downloading', 'finalizing', 'uploaded', 'uploading'].includes(status);
        });
        
        console.log('[HOME] Active reviews check after update:', { 
          hasActiveReviews, 
          totalReviews: normalized.length,
          statuses: normalized.map(r => r.status)
        });
        
        // Hide success message if no active reviews (all completed)
        if (!hasActiveReviews && uploadSuccess) {
          uploadSuccess.hidden = true;
        }
        
        // Stop auto-refresh if no active reviews
        if (!hasActiveReviews && autoRefreshInterval) {
          console.log('[HOME] No more active reviews - stopping auto-refresh');
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
          console.log('[HOME] Auto-refresh stopped. All reviews completed or failed.');
        }
        
        // Store last review data for reference
        window.lastReviewData = normalized;
        
      } catch (error) {
        console.error('Error updating review history:', error);
        // Stop auto-refresh on network error to prevent continuous failed requests
        if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
          autoRefreshInterval = null;
          console.log('Auto-refresh stopped due to network error');
        }
      } finally {
        isRefreshing = false;
      }
    }
    
    // Helper function to create loading dots using DOM (CSP-compliant)
    function createLoadingDots() {
      const container = document.createElement('span');
      container.className = 'loading-dots';
      
      for (let i = 0; i < 3; i++) {
        const dot = document.createElement('span');
        dot.textContent = '.';
        container.appendChild(dot);
      }
      
      return container;
    }
    
    // Helper to create status content with loading dots (CSP-compliant)
    function createStatusContent(cell, status) {
      const statusLower = (status || '').toLowerCase();
      cell.classList.add('govuk-body');
      
      // Clear existing content
      while (cell.firstChild) {
        cell.removeChild(cell.firstChild);
      }
      
      // Map status to display text with three dots
      let displayText = '';
      if (statusLower === 'processing') {
        displayText = 'Processing...';
      } else if (statusLower === 'analyzing') {
        displayText = 'Analyzing...';
      } else if (statusLower === 'reviewing') {
        displayText = 'Reviewing...';
      } else if (statusLower === 'downloading') {
        displayText = 'Downloading...';
      } else if (statusLower === 'finalizing') {
        displayText = 'Finalizing...';
      } else if (statusLower === 'queued') {
        displayText = 'Queued...';
      } else if (statusLower === 'uploading') {
        displayText = 'Uploading...';
      } else if (statusLower === 'uploaded') {
        displayText = 'Uploaded...';
      } else {
        displayText = status;
      }
      
      cell.textContent = displayText;
    }
    
    // Update the review table with new data
    function updateReviewTable(reviews) {
      const tbody = document.getElementById('reviewHistoryBody');
      
      if (!reviews || reviews.length === 0) {
        tbody.innerHTML = '<tr class="govuk-table__row"><td class="govuk-table__cell" colspan="5"><p class="govuk-body">No review history available.</p></td></tr>';
        return;
      }
      
      tbody.innerHTML = '';
      
      reviews.forEach(review => {
        const row = document.createElement('tr');
        row.className = 'govuk-table__row';
        
        // Filename
        const filenameCell = document.createElement('td');
        filenameCell.className = 'govuk-table__cell';
        filenameCell.textContent = review.filename || 'N/A';
        row.appendChild(filenameCell);
        
      
        // Status
        const statusCell = document.createElement('td');
        statusCell.className = 'govuk-table__cell';
        const statusTag = document.createElement('strong');
        statusTag.className = 'govuk-tag';
        
        const status = (review.status || '').toLowerCase();
        if (status === 'completed') {
          statusTag.classList.add('govuk-tag--green');
          statusTag.textContent = 'Completed';
        } else if (status === 'processing') {
          statusTag.classList.add('govuk-tag--blue');
          createStatusContent(statusTag, 'Processing');
        } else if (status === 'pending') {
          statusTag.classList.add('govuk-tag--yellow');
          createStatusContent(statusTag, 'Pending');
        } else if (status === 'failed') {
          statusTag.classList.add('govuk-tag--red');
          statusTag.textContent = 'Failed';
        } else {
          statusTag.classList.add('govuk-tag--grey');
          statusTag.textContent = review.status ? review.status.charAt(0).toUpperCase() + review.status.slice(1) : 'Unknown';
        }
        
        statusCell.appendChild(statusTag);
        row.appendChild(statusCell);
        
        // Timestamp
        const timestampCell = document.createElement('td');
        timestampCell.className = 'govuk-table__cell';
        const timestamp = review.uploadedAt || review.createdAt || review.updatedAt;
        
        // Debug logging for timestamp issues
        if (!timestamp) {
          console.warn('[HOME] Review missing all timestamp fields:', {
            id: review.id,
            uploadedAt: review.uploadedAt,
            createdAt: review.createdAt,
            updatedAt: review.updatedAt,
            status: review.status
          });
        }
        
        if (timestamp) {
          const date = new Date(timestamp);
          timestampCell.textContent = date.toLocaleString('en-GB', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        } else {
          timestampCell.textContent = 'N/A';
        }
        row.appendChild(timestampCell);
        
        // Result
        const resultCell = document.createElement('td');
        resultCell.className = 'govuk-table__cell';
        
        if (status === 'completed') {
          const link = document.createElement('a');
          const reviewIdentifier = review.reviewId || review.id;
          if (!reviewIdentifier) {
            link.textContent = 'Missing ID';
            link.removeAttribute('href');
          } else {
            link.href = `/review/results/${reviewIdentifier}`;
          }
          link.className = 'govuk-link';
          link.textContent = 'View results';
          resultCell.appendChild(link);
        } else if (status === 'failed') {
          const errorSpan = document.createElement('span');
          errorSpan.className = 'govuk-error-message';
          errorSpan.textContent = 'Review failed';
          resultCell.appendChild(errorSpan);
        } else if (status === 'processing') {
          const span = document.createElement('span');
          span.className = 'govuk-body';
          createStatusContent(span, 'Processing');
          resultCell.appendChild(span);
        } else if (status === 'pending') {
          const span = document.createElement('span');
          span.className = 'govuk-body';
          createStatusContent(span, 'Pending');
          resultCell.appendChild(span);
        } else {
          resultCell.textContent = review.status || 'Unknown';
        }
        
        row.appendChild(resultCell);
        tbody.appendChild(row);
      });
    }
    
    // Start auto-refresh
    function startAutoRefresh() {
      if (autoRefreshInterval) {
        console.log('[HOME] Auto-refresh already running');
        return; // Already running
      }
      
      console.log('[HOME] Starting auto-refresh with 5 second interval...');
      autoRefreshInterval = setInterval(updateReviewHistory, 5000);
    }
    
    // Check if there are any active reviews on page load
    const tableRows = document.querySelectorAll('#reviewHistoryBody tr');
    let hasActiveReviews = false;
    let activeStatuses = [];
    
    tableRows.forEach(row => {
      const statusCell = row.querySelector('.govuk-tag');
      if (statusCell) {
        const statusText = statusCell.textContent.trim();
        if (statusCell.classList.contains('govuk-tag--blue') ||
            statusCell.classList.contains('govuk-tag--yellow') ||
            statusCell.classList.contains('govuk-tag--grey')) {
          hasActiveReviews = true;
          activeStatuses.push(statusText);
        }
      }
    });
    
    console.log('[HOME] Active reviews check:', { hasActiveReviews, count: activeStatuses.length, statuses: activeStatuses });
    
    // Start auto-refresh if there are active reviews
    if (hasActiveReviews) {
      console.log('[HOME] Active reviews detected, starting auto-refresh');
      // Do an immediate update first to get latest status
      updateReviewHistory().then(() => {
        console.log('[HOME] Initial update complete');
      });
      // Then start the interval
      startAutoRefresh();
    } else {
      console.log('[HOME] No active reviews detected, auto-refresh not started');
    }
    
    // Clean up interval when page is unloaded
    window.addEventListener('beforeunload', () => {
      if (autoRefreshInterval) {
        clearInterval(autoRefreshInterval);
      }
    });
  </script>
{% endblock %}
