{% extends 'layouts/page.njk' %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      
      <h1 class="govuk-heading-l">Content Review Assistant</h1>
      
      <!-- Quick Actions -->
      <div class="govuk-button-group govuk-!-margin-bottom-6">
        <a href="/upload" class="govuk-button" data-module="govuk-button">
          Upload Document
        </a>
      </div>

      <!-- Upload Success Message -->
      {% if uploadSuccess %}
      <div class="govuk-notification-banner govuk-notification-banner--success" role="alert" aria-labelledby="upload-success-title" data-module="govuk-notification-banner">
        <div class="govuk-notification-banner__header">
          <h2 class="govuk-notification-banner__title" id="upload-success-title">
            Success
          </h2>
        </div>
        <div class="govuk-notification-banner__content">
          <h3 class="govuk-notification-banner__heading">
            Document uploaded successfully
          </h3>
          <p class="govuk-body">
            <strong>{{ uploadSuccess.filename }}</strong> ({{ (uploadSuccess.size / 1024) | round(2) }} KB) has been uploaded and scanned.
          </p>
        </div>
      </div>
      {% endif %}

      <!-- Upload Error Message -->
      {% if uploadError %}
      <div class="govuk-error-summary" aria-labelledby="error-summary-title" role="alert" tabindex="-1" data-module="govuk-error-summary">
        <h2 class="govuk-error-summary__title" id="error-summary-title">
          Upload failed
        </h2>
        <div class="govuk-error-summary__body">
          <p class="govuk-body">{{ uploadError }}</p>
        </div>
      </div>
      {% endif %}

      <p class="govuk-body">
        Upload a document or paste content below for review. The content will be analyzed for clarity, formatting and compliance with GOV.UK standards.
      </p>

      <!-- Content Review Form -->
      <div class="govuk-!-margin-bottom-6">
        <form id="reviewForm" enctype="multipart/form-data">
          
          <!-- File Upload Option -->
          <div class="govuk-form-group" id="fileFormGroup">
            <label class="govuk-label govuk-label--s" for="file-upload">
              Upload a document (optional)
            </label>
            <div class="govuk-hint">
              Accepted file types: PDF (.pdf), Word (.doc, .docx). Maximum file size: 10MB
            </div>
            <input class="govuk-file-upload" id="file-upload" name="file" type="file" accept=".pdf,.doc,.docx,application/pdf,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document">
          </div>

          <!-- Text Input Option -->
          <div class="govuk-form-group">
            <label class="govuk-label govuk-label--s" for="userInput">
              Or type/paste your content directly
            </label>
            <textarea 
              id="userInput" 
              class="govuk-textarea" 
              rows="5" 
              placeholder="Type or paste content here..."
              aria-label="Content input for review"
            ></textarea>
          </div>
          
          <button 
            type="submit" 
            class="govuk-button"
            data-module="govuk-button"
            id="reviewButton"
          >
            Review Content
          </button>
        </form>
      </div>

      <!-- Document Review History Table -->
      <h2 class="govuk-heading-m govuk-!-margin-top-8">Review History</h2>
        
      <table class="govuk-table" id="reviewHistoryTable">
        <thead class="govuk-table__head">
          <tr class="govuk-table__row">
            <th scope="col" class="govuk-table__header">Uploaded Document</th>
            <th scope="col" class="govuk-table__header">Method</th>
            <th scope="col" class="govuk-table__header">Status</th>
            <th scope="col" class="govuk-table__header">Timestamp</th>
            <th scope="col" class="govuk-table__header">Result</th>
          </tr>
        </thead>
        <tbody class="govuk-table__body" id="reviewHistoryBody">
          {% if reviewHistory and reviewHistory.length > 0 %}
            {% for review in reviewHistory %}
            <tr class="govuk-table__row">
              <td class="govuk-table__cell">{{ review.filename }}</td>
              <td class="govuk-table__cell">Review Content</td>
              <td class="govuk-table__cell">
                {% if review.status === 'completed' %}
                  <strong class="govuk-tag govuk-tag--green">Completed</strong>
                {% elif review.status === 'processing' or review.status === 'analyzing' %}
                  <strong class="govuk-tag govuk-tag--yellow">Reviewing Content</strong>
                {% elif review.status === 'queued' %}
                  <strong class="govuk-tag govuk-tag--yellow">Queued</strong>
                {% elif review.status === 'uploading' %}
                  <strong class="govuk-tag govuk-tag--blue">Uploading</strong>
                {% elif review.status === 'failed' %}
                  <strong class="govuk-tag govuk-tag--red">Failed</strong>
                {% else %}
                  <strong class="govuk-tag govuk-tag--grey">{{ review.status | title }}</strong>
                {% endif %}
              </td>
              <td class="govuk-table__cell">
                {% if review.uploadedAt %}
                  {{ review.uploadedAt | date('dd/MM/yyyy, HH:mm') }}
                {% else %}
                  N/A
                {% endif %}
              </td>
              <td class="govuk-table__cell">
                {% if review.status === 'completed' %}
                  <a href="/review/results/{{ review.reviewId }}" class="govuk-link">View results</a>
                {% elif review.status === 'failed' %}
                  <span style="color: #d4351c;">Review failed</span>
                {% elif review.status === 'processing' or review.status === 'analyzing' %}
                  <span style="color: #f47738;">LLM processing...</span>
                {% elif review.status === 'queued' %}
                  <span style="color: #f47738;">In SQS queue...</span>
                {% elif review.status === 'uploading' %}
                  <span style="color: #1d70b8;">Uploading to S3...</span>
                {% else %}
                  <span>{{ review.status }}</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr class="govuk-table__row">
              <td class="govuk-table__cell" colspan="5">
                <p class="govuk-body">No review history available.</p>
              </td>
            </tr>
          {% endif %}
        </tbody>
      </table>

    </div>
  </div>

{% endblock %}

{% block bodyEnd %}
  <script nonce="{{ cspNonce }}">
    console.log('Content Review Assistant - Home Page Loaded');
    
    // Auto-refresh if there are active reviews (processing, queued, uploading, analyzing)
    const hasActiveReviews = {{ (reviewHistory | selectattr('status', 'in', ['processing', 'analyzing', 'queued', 'uploading']) | list | length > 0) | dump }};
    
    if (hasActiveReviews) {
      console.log('Active reviews detected - auto-refreshing in 5 seconds...');
      // Refresh page every 5 seconds to update status from S3/SQS/MongoDB
      setTimeout(() => {
        window.location.reload();
      }, 5000);
    }
    
    // Handle review form submission
    const reviewForm = document.getElementById('reviewForm');
    if (reviewForm) {
      reviewForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const fileInput = document.getElementById('file-upload');
        const textInput = document.getElementById('userInput');
        
        if (fileInput && fileInput.files.length > 0) {
          // Redirect to upload page for file upload
          window.location.href = '/upload';
        } else if (textInput && textInput.value.trim()) {
          alert('Text content review functionality coming soon!');
        } else {
          alert('Please upload a file or enter text content to review.');
        }
      });
    }
  </script>
  {{ super() }}
{% endblock %}
