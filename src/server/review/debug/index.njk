{% extends "layouts/page.njk" %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      
      <a href="/review/results/{{ results.id }}" class="govuk-back-link">Back to results</a>
      
      <div class="govuk-warning-text">
        <span class="govuk-warning-text__icon" aria-hidden="true">!</span>
        <strong class="govuk-warning-text__text">
          <span class="govuk-warning-text__assistive">Warning</span>
          This is a debug view for backend users and developers only
        </strong>
      </div>

      <h1 class="govuk-heading-xl">{{ heading }}</h1>
      
      <p class="govuk-body-l">
        This page shows the internal processing workflow for review ID: <code>{{ results.id }}</code>
      </p>

      <!-- Document Information -->
      <dl class="govuk-summary-list govuk-!-margin-bottom-6">
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">Document</dt>
          <dd class="govuk-summary-list__value">{{ results.documentName }}</dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">Review ID</dt>
          <dd class="govuk-summary-list__value"><code>{{ results.id }}</code></dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">S3 Result Location</dt>
          <dd class="govuk-summary-list__value"><code>{{ results.s3Location }}</code></dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">LLM Model</dt>
          <dd class="govuk-summary-list__value">{{ results.llmModel }}</dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">Processing Time</dt>
          <dd class="govuk-summary-list__value">{{ results.processingTime }}</dd>
        </div>
      </dl>

      <!-- Workflow Steps -->
      <h2 class="govuk-heading-l">Processing Workflow Steps</h2>
      <p class="govuk-body">
        Below is the complete workflow showing how the document was processed through the system:
      </p>
      
      <div class="govuk-!-margin-bottom-6">
        <table class="govuk-table">
          <thead class="govuk-table__head">
            <tr class="govuk-table__row">
              <th scope="col" class="govuk-table__header" style="width: 10%">Step #</th>
              <th scope="col" class="govuk-table__header" style="width: 40%">Process</th>
              <th scope="col" class="govuk-table__header" style="width: 25%">Status</th>
              <th scope="col" class="govuk-table__header" style="width: 25%">Timestamp</th>
            </tr>
          </thead>
          <tbody class="govuk-table__body">
            {% for step in results.workflowSteps %}
            <tr class="govuk-table__row">
              <td class="govuk-table__cell">{{ loop.index }}</td>
              <td class="govuk-table__cell">
                <strong>{{ step.step }}</strong>
                <br>
                <span class="govuk-hint govuk-!-font-size-16">
                  {% if loop.index == 1 %}
                    File uploaded to S3 bucket for storage and processing
                  {% elif loop.index == 2 %}
                    Message sent to SQS queue to trigger processing workflow
                  {% elif loop.index == 3 %}
                    SQS Orchestrator received message and initiated processing
                  {% elif loop.index == 4 %}
                    AI/LLM analyzed content and generated review findings
                  {% elif loop.index == 5 %}
                    Results saved to S3 bucket for retrieval
                  {% endif %}
                </span>
              </td>
              <td class="govuk-table__cell">
                <strong class="govuk-tag govuk-tag--green">{{ step.status }}</strong>
              </td>
              <td class="govuk-table__cell">
                {{ step.timestamp | formatDate('dd/MM/yyyy HH:mm:ss') }}
                <br>
                <span class="govuk-hint govuk-!-font-size-14">
                  ({{ step.timestamp | formatDate('HH:mm:ss') }})
                </span>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- Technical Details -->
      <details class="govuk-details">
        <summary class="govuk-details__summary">
          <span class="govuk-details__summary-text">
            View technical details (JSON)
          </span>
        </summary>
        <div class="govuk-details__text">
          <pre><code>{{ results | dump(2) }}</code></pre>
        </div>
      </details>

      <!-- Actions -->
      <div class="govuk-button-group govuk-!-margin-top-6">
        <a href="/review/results/{{ results.id }}" class="govuk-button" data-module="govuk-button">
          View User-Facing Results
        </a>
        <a href="/" class="govuk-link">
          Back to home
        </a>
      </div>

    </div>
  </div>

<style nonce="{{ cspNonce }}">
  pre code {
    display: block;
    background: #f3f2f1;
    padding: 1rem;
    overflow-x: auto;
    font-size: 14px;
  }
</style>
{% endblock %}
