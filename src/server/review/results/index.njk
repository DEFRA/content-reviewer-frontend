{% extends "layouts/page.njk" %}

{% block content %}
  <div class="govuk-grid-row">
    <div class="govuk-grid-column-full">
      
      <a href="/" class="govuk-back-link">Back to home</a>
      
      <h1 class="govuk-heading-xl">{{ heading }}</h1>
      
      <!-- Overall Status Banner -->
      {% set statusClass = 'govuk-tag--green' if results.summary.overallStatus == 'pass' else 
                           ('govuk-tag--blue' if results.summary.overallStatus == 'pass_with_recommendations' else 
                           ('govuk-tag--yellow' if results.summary.overallStatus == 'needs_improvement' else 'govuk-tag--red')) %}
      
      <div class="govuk-notification-banner govuk-notification-banner--success" role="region" aria-labelledby="govuk-notification-banner-title" data-module="govuk-notification-banner">
        <div class="govuk-notification-banner__header">
          <h2 class="govuk-notification-banner__title" id="govuk-notification-banner-title">
            Review Complete
          </h2>
        </div>
        <div class="govuk-notification-banner__content">
          <p class="govuk-notification-banner__heading">
            Overall Status: <strong class="govuk-tag {{ statusClass }}">{{ results.summary.overallStatus | replace('_', ' ') | title }}</strong>
          </p>
        </div>
      </div>

      <!-- Document Information -->
      <dl class="govuk-summary-list govuk-!-margin-bottom-6">
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">Document</dt>
          <dd class="govuk-summary-list__value">{{ results.documentName }}</dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">Review Date</dt>
          <dd class="govuk-summary-list__value">{{ results.reviewDate }}</dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">S3 Location</dt>
          <dd class="govuk-summary-list__value"><code>{{ results.s3Location }}</code></dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">AI Model</dt>
          <dd class="govuk-summary-list__value">{{ results.llmModel }}</dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">Processing Time</dt>
          <dd class="govuk-summary-list__value">{{ results.processingTime }}</dd>
        </div>
        <div class="govuk-summary-list__row">
          <dt class="govuk-summary-list__key">Tokens Used</dt>
          <dd class="govuk-summary-list__value">{{ results.aiUsage.totalTokens }} (Input: {{ results.aiUsage.inputTokens }}, Output: {{ results.aiUsage.outputTokens }})</dd>
        </div>
      </dl>

      <!-- Export Options -->
      <div class="govuk-button-group govuk-!-margin-bottom-8">
        <button type="button" class="govuk-button" data-module="govuk-button" id="exportPdfBtn">
          Download as PDF
        </button>
        <button type="button" class="govuk-button govuk-button--secondary" data-module="govuk-button" id="exportWordBtn">
          Download as Word
        </button>
        <button type="button" class="govuk-button govuk-button--secondary" data-module="govuk-button" id="exportJsonBtn">
          Download Results (JSON)
        </button>
        <button type="button" class="govuk-button govuk-button--secondary" data-module="govuk-button" id="exportTextBtn">
          Download Report (Text)
        </button>
        <button type="button" class="govuk-button govuk-button--secondary" data-module="govuk-button" id="printBtn">
          Print Report
        </button>
      </div>

      <!-- Review Summary -->
      <h2 class="govuk-heading-l">Summary</h2>
      
      <div class="govuk-grid-row govuk-!-margin-bottom-6">
        <div class="govuk-grid-column-one-quarter">
          <div class="app-stat-card">
            <h3 class="govuk-heading-s">Overall Score</h3>
            <p class="govuk-body govuk-!-font-size-48 govuk-!-font-weight-bold">{{ results.summary.overallScore }}</p>
          </div>
        </div>
        <div class="govuk-grid-column-one-quarter">
          <div class="app-stat-card">
            <h3 class="govuk-heading-s">Issues Found</h3>
            <p class="govuk-body govuk-!-font-size-48 govuk-!-font-weight-bold">{{ results.summary.issuesFound }}</p>
          </div>
        </div>
        <div class="govuk-grid-column-one-quarter">
          <div class="app-stat-card">
            <h3 class="govuk-heading-s">Words to Avoid</h3>
            <p class="govuk-body govuk-!-font-size-24">{{ results.summary.wordsToAvoid }}</p>
          </div>
        </div>
        <div class="govuk-grid-column-one-quarter">
          <div class="app-stat-card">
            <h3 class="govuk-heading-s">Passive Sentences</h3>
            <p class="govuk-body govuk-!-font-size-24">{{ results.summary.passiveSentences }}</p>
          </div>
        </div>
      </div>

      <!-- Overall Assessment -->
      <h2 class="govuk-heading-l">Overall Assessment</h2>
      <div class="govuk-inset-text">
        {{ results.sections.overallAssessment | safe }}
      </div>

      <!-- Detailed Sections -->
      <h2 class="govuk-heading-l">Detailed Review</h2>
      
      <div class="govuk-accordion" data-module="govuk-accordion" id="review-sections">
        
        <!-- Content Quality -->
        <div class="govuk-accordion__section">
          <div class="govuk-accordion__section-header">
            <h2 class="govuk-accordion__section-heading">
              <span class="govuk-accordion__section-button" id="accordion-heading-1">
                Content Quality
              </span>
            </h2>
          </div>
          <div id="accordion-content-1" class="govuk-accordion__section-content" aria-labelledby="accordion-heading-1">
            <div class="govuk-body">{{ results.sections.contentQuality | safe }}</div>
          </div>
        </div>

        <!-- Plain English Review -->
        <div class="govuk-accordion__section">
          <div class="govuk-accordion__section-header">
            <h2 class="govuk-accordion__section-heading">
              <span class="govuk-accordion__section-button" id="accordion-heading-2">
                Plain English Review
              </span>
            </h2>
          </div>
          <div id="accordion-content-2" class="govuk-accordion__section-content" aria-labelledby="accordion-heading-2">
            <div class="govuk-body">{{ results.sections.plainEnglish | safe }}</div>
          </div>
        </div>

        <!-- Style Guide Compliance -->
        <div class="govuk-accordion__section">
          <div class="govuk-accordion__section-header">
            <h2 class="govuk-accordion__section-heading">
              <span class="govuk-accordion__section-button" id="accordion-heading-3">
                GOV.UK Style Guide Compliance
              </span>
            </h2>
          </div>
          <div id="accordion-content-3" class="govuk-accordion__section-content" aria-labelledby="accordion-heading-3">
            <div class="govuk-body">{{ results.sections.styleGuide | safe }}</div>
          </div>
        </div>

        <!-- Govspeak Review -->
        <div class="govuk-accordion__section">
          <div class="govuk-accordion__section-header">
            <h2 class="govuk-accordion__section-heading">
              <span class="govuk-accordion__section-button" id="accordion-heading-4">
                Govspeak & Formatting Review
              </span>
            </h2>
          </div>
          <div id="accordion-content-4" class="govuk-accordion__section-content" aria-labelledby="accordion-heading-4">
            <div class="govuk-body">{{ results.sections.govspeak | safe }}</div>
          </div>
        </div>

        <!-- Accessibility Review -->
        <div class="govuk-accordion__section">
          <div class="govuk-accordion__section-header">
            <h2 class="govuk-accordion__section-heading">
              <span class="govuk-accordion__section-button" id="accordion-heading-5">
                Accessibility Review
              </span>
            </h2>
          </div>
          <div id="accordion-content-5" class="govuk-accordion__section-content" aria-labelledby="accordion-heading-5">
            <div class="govuk-body">{{ results.sections.accessibility | safe }}</div>
          </div>
        </div>

        <!-- Passive Voice Review -->
        <div class="govuk-accordion__section">
          <div class="govuk-accordion__section-header">
            <h2 class="govuk-accordion__section-heading">
              <span class="govuk-accordion__section-button" id="accordion-heading-6">
                Passive Voice Analysis
              </span>
            </h2>
          </div>
          <div id="accordion-content-6" class="govuk-accordion__section-content" aria-labelledby="accordion-heading-6">
            <div class="govuk-body">{{ results.sections.passiveVoice | safe }}</div>
          </div>
        </div>

        <!-- Summary of Findings -->
        <div class="govuk-accordion__section">
          <div class="govuk-accordion__section-header">
            <h2 class="govuk-accordion__section-heading">
              <span class="govuk-accordion__section-button" id="accordion-heading-7">
                Summary of Findings
              </span>
            </h2>
          </div>
          <div id="accordion-content-7" class="govuk-accordion__section-content" aria-labelledby="accordion-heading-7">
            <div class="govuk-body">{{ results.sections.summaryOfFindings | safe }}</div>
          </div>
        </div>

        <!-- Example Improvements -->
        <div class="govuk-accordion__section">
          <div class="govuk-accordion__section-header">
            <h2 class="govuk-accordion__section-heading">
              <span class="govuk-accordion__section-button" id="accordion-heading-8">
                Example Improvements
              </span>
            </h2>
          </div>
          <div id="accordion-content-8" class="govuk-accordion__section-content" aria-labelledby="accordion-heading-8">
            <div class="govuk-body">{{ results.sections.exampleImprovements | safe }}</div>
          </div>
        </div>

      </div>

      <!-- Actions -->
      <div class="govuk-button-group govuk-!-margin-top-6">
        <a href="/upload" class="govuk-button" data-module="govuk-button">
          Review Another Document
        </a>
        <a href="/" class="govuk-link">
          Back to home
        </a>
      </div>

    </div>
  </div>
{% endblock %}

{% block bodyEnd %}
  {{ super() }}
  <script nonce="{{ cspNonce }}">
    const reviewId = '{{ reviewId }}';
    const resultsData = {{ results.rawData | dump | safe }};

    // Export as PDF
    document.getElementById('exportPdfBtn').addEventListener('click', () => {
      window.location.href = `/review/export/${reviewId}/pdf`;
    });

    // Export as Word
    document.getElementById('exportWordBtn').addEventListener('click', () => {
      window.location.href = `/review/export/${reviewId}/word`;
    });

    // Export as JSON
    document.getElementById('exportJsonBtn').addEventListener('click', () => {
      const dataStr = JSON.stringify(resultsData, null, 2);
      const dataBlob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `review-results-${reviewId}.json`;
      link.click();
      URL.revokeObjectURL(url);
    });

    // Export as Text
    document.getElementById('exportTextBtn').addEventListener('click', () => {
      const textContent = generateTextReport();
      const textBlob = new Blob([textContent], { type: 'text/plain' });
      const url = URL.createObjectURL(textBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `review-report-${reviewId}.txt`;
      link.click();
      URL.revokeObjectURL(url);
    });

    // Print
    document.getElementById('printBtn').addEventListener('click', () => {
      window.print();
    });

    // Generate text report
    function generateTextReport() {
      const results = {{ results | dump | safe }};
      let report = '';
      report += '='.repeat(80) + '\n';
      report += 'GOV.UK CONTENT REVIEW REPORT\n';
      report += '='.repeat(80) + '\n\n';
      report += `Document: ${results.documentName}\n`;
      report += `Review Date: ${results.reviewDate}\n`;
      report += `AI Model: ${results.llmModel}\n`;
      report += `Processing Time: ${results.processingTime}\n`;
      report += `Overall Status: ${results.summary.overallStatus}\n`;
      report += `Overall Score: ${results.summary.overallScore}/100\n\n`;
      report += '='.repeat(80) + '\n';
      report += 'SUMMARY\n';
      report += '='.repeat(80) + '\n';
      report += `Issues Found: ${results.summary.issuesFound}\n`;
      report += `Words to Avoid: ${results.summary.wordsToAvoid}\n`;
      report += `Passive Sentences: ${results.summary.passiveSentences}\n\n`;
      report += '='.repeat(80) + '\n';
      report += 'FULL REVIEW\n';
      report += '='.repeat(80) + '\n\n';
      report += results.fullReviewText;
      report += '\n\n' + '='.repeat(80) + '\n';
      report += 'END OF REPORT\n';
      report += '='.repeat(80) + '\n';
      return report;
    }
  </script>
  
  <style nonce="{{ cspNonce }}">
    .app-stat-card {
      background: #f3f2f1;
      padding: 1.5rem;
      text-align: center;
      border-left: 4px solid #1d70b8;
      height: 100%;
    }
    .app-stat-card h3 {
      margin-bottom: 0.5rem;
    }
    .app-confidence-badge {
      margin-left: 10px;
    }
    
    @media print {
      .govuk-back-link,
      .govuk-button-group,
      #exportJsonBtn,
      #exportTextBtn,
      #exportPdfBtn,
      #exportWordBtn,
      #printBtn {
        display: none;
      }
    }
  </style>
{% endblock %}
